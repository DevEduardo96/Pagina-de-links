<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Painel Administrativo - Gerenciador de Links</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.38.0/dist/umd/supabase.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body
    class="bg-gradient-to-br from-indigo-500 to-purple-600 min-h-screen font-sans text-gray-800"
  >
    <!-- Login Screen -->
    <div
      id="loginScreen"
      class="flex items-center justify-center min-h-screen px-4"
    >
      <div
        class="bg-white rounded-2xl shadow-xl p-10 max-w-sm w-full text-center"
      >
        <h1
          class="text-2xl font-bold bg-gradient-to-r from-indigo-500 to-purple-600 bg-clip-text text-transparent mb-2"
        >
          Painel Admin
        </h1>
        <p class="text-gray-500 mb-6">Gerencie seus links e perfil</p>

        <div id="authMessage"></div>

        <div id="loginForm">
          <div class="mb-4 text-left">
            <label class="block font-semibold mb-2">Email</label>
            <input
              type="email"
              id="loginEmail"
              class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-400"
              placeholder="seu@email.com"
              required
            />
          </div>
          <div class="mb-4 text-left">
            <label class="block font-semibold mb-2">Senha</label>
            <input
              type="password"
              id="loginPassword"
              class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-400"
              placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
              required
            />
          </div>
          <button
            onclick="login()"
            class="w-full py-3 bg-indigo-500 hover:bg-indigo-600 text-white rounded-xl font-bold uppercase"
          >
            Entrar
          </button>
          <button
            onclick="showRegisterForm()"
            class="w-full py-3 mt-3 border-2 border-indigo-500 text-indigo-500 hover:bg-indigo-500 hover:text-white rounded-xl font-bold uppercase"
          >
            Criar Conta
          </button>
        </div>

        <div id="registerForm" style="display: none">
          <div class="mb-4 text-left">
            <label class="block font-semibold mb-2">Nome</label>
            <input
              type="text"
              id="registerName"
              class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl"
              placeholder="Seu nome"
              required
            />
          </div>
          <div class="mb-4 text-left">
            <label class="block font-semibold mb-2">Email</label>
            <input
              type="email"
              id="registerEmail"
              class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl"
              placeholder="seu@email.com"
              required
            />
          </div>
          <div class="mb-4 text-left">
            <label class="block font-semibold mb-2">Senha</label>
            <input
              type="password"
              id="registerPassword"
              class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl"
              placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
              required
            />
          </div>
          <button
            onclick="register()"
            class="w-full py-3 bg-indigo-500 text-white rounded-xl font-bold uppercase"
          >
            Criar Conta
          </button>
          <button
            onclick="showLoginForm()"
            class="w-full py-3 mt-3 border-2 border-indigo-500 text-indigo-500 hover:bg-indigo-500 hover:text-white rounded-xl font-bold uppercase"
          >
            J√° tenho conta
          </button>
        </div>
      </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" class="hidden">
      <div class="max-w-6xl mx-auto p-6">
        <div
          class="bg-white rounded-2xl shadow-md p-6 mb-8 flex flex-col md:flex-row justify-between items-center gap-4"
        >
          <div>
            <h1
              class="text-2xl font-bold bg-gradient-to-r from-indigo-500 to-purple-600 bg-clip-text text-transparent"
            >
              Painel Administrativo
            </h1>
            <p class="text-gray-500">Gerencie seus links e perfil</p>
          </div>
          <div class="flex items-center gap-4">
            <div
              id="userAvatar"
              class="w-12 h-12 rounded-full bg-gradient-to-r from-indigo-500 to-purple-600 text-white flex items-center justify-center font-bold text-lg"
            >
              U
            </div>
            <div>
              <div id="userName" class="font-bold">Usu√°rio</div>
              <div id="userEmail" class="text-sm text-gray-500">
                email@example.com
              </div>
            </div>
            <button
              onclick="viewPublicPage()"
              class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm"
            >
              Ver P√°gina
            </button>
            <button
              onclick="logout()"
              class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm"
            >
              Sair
            </button>
          </div>
        </div>

        <div id="dashboardMessage"></div>

        <!-- Cards -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          <!-- Perfil -->
          <div class="bg-white rounded-2xl shadow-md p-6">
            <h2 class="text-xl font-bold mb-4">Perfil</h2>
            <div class="text-center mb-6">
              <div
                id="profilePreview"
                class="w-28 h-28 rounded-full bg-gradient-to-r from-indigo-500 to-purple-600 flex items-center justify-center text-white text-4xl font-bold mx-auto overflow-hidden"
              >
                <span id="profileInitials">U</span>
              </div>
              <input
                type="file"
                id="profileImage"
                class="hidden"
                accept="image/*"
                onchange="uploadProfileImage()"
              />
              <label
                for="profileImage"
                class="mt-3 inline-block px-4 py-2 bg-indigo-500 text-white rounded-md cursor-pointer hover:bg-indigo-600"
                >Alterar Foto</label
              >
            </div>
            <div class="mb-4">
              <label class="block font-semibold mb-2">Nome</label>
              <input
                id="profileName"
                type="text"
                class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-400"
                placeholder="Seu nome"
              />
            </div>
            <div class="mb-4">
              <label class="block font-semibold mb-2">Descri√ß√£o</label>
              <textarea
                id="profileDescription"
                rows="3"
                class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-400"
                placeholder="Fale sobre voc√™"
              ></textarea>
            </div>
            <button
              onclick="saveProfile()"
              class="w-full py-3 bg-indigo-500 hover:bg-indigo-600 text-white rounded-xl font-bold"
            >
              Salvar Perfil
            </button>
          </div>

          <!-- Meus Links -->
          <div class="bg-white rounded-2xl shadow-md p-6 col-span-2">
            <div
              class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4"
            >
              <h2 class="text-xl font-bold">Meus Links</h2>
              <button
                onclick="showAddLinkModal()"
                class="px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-md font-semibold"
              >
                + Adicionar Link
              </button>
            </div>
            <div id="linksList">
              <div class="text-center py-6">
                <div
                  class="w-10 h-10 border-4 border-gray-200 border-t-indigo-500 rounded-full animate-spin mx-auto mb-2"
                ></div>
                <p class="text-gray-500">Carregando links...</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal -->
    <div
      id="linkModal"
      class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50"
    >
      <div class="bg-white p-6 rounded-2xl shadow-xl max-w-lg w-full mx-4">
        <h3 id="modalTitle" class="text-xl font-bold text-center mb-4">
          Adicionar Link
        </h3>
        <div class="mb-4">
          <label class="block font-semibold mb-2">T√≠tulo</label>
          <input
            type="text"
            id="linkTitle"
            class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-400"
            placeholder="Nome do produto/servi√ßo"
          />
        </div>
        <div class="mb-4">
          <label class="block font-semibold mb-2">URL</label>
          <input
            type="url"
            id="linkUrl"
            class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-400"
            placeholder="https://exemplo.com"
          />
        </div>
        <div class="mb-4">
          <label class="block font-semibold mb-2">√çcone</label>
          <input
            type="text"
            id="linkIcon"
            class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-400"
            placeholder="üì±"
            maxlength="10"
          />
        </div>
        <div class="mb-4">
          <label class="block font-semibold mb-2">Tipo</label>
          <select
            id="linkType"
            class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-400"
          >
            <option value="product">Produto</option>
            <option value="social">Rede Social</option>
            <option value="contact">Contato</option>
            <option value="other">Outro</option>
          </select>
        </div>
        <div class="flex justify-end gap-3 mt-6">
          <button
            onclick="closeLinkModal()"
            class="px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-md"
          >
            Cancelar
          </button>
          <button
            onclick="saveLink()"
            class="px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-md"
          >
            Salvar
          </button>
        </div>
      </div>
    </div>

    <!-- Scripts -->
    <script>
      // üîê Configura√ß√£o do Supabase
      const SUPABASE_URL = "https://mfuiqabijexayjoelqrx.supabase.co";
      const SUPABASE_ANON_KEY =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1mdWlxYWJpamV4YXlqb2VscXJ4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM0NTIxMzMsImV4cCI6MjA2OTAyODEzM30._vU2hLj5wJyEi4ggKV3zOWdtoIUd_PAhCEZWPce4WXU";

      const supabase = window.supabase.createClient(
        SUPABASE_URL,
        SUPABASE_ANON_KEY
      );
      let currentUser = null;
      let editingLinkId = null;

      // ‚úÖ Executado ao carregar a p√°gina
      window.addEventListener("load", async () => {
        try {
          const {
            data: { session },
          } = await supabase.auth.getSession();

          if (session) {
            const {
              data: { user },
              error,
            } = await supabase.auth.getUser();
            if (error || !user) throw new Error("Usu√°rio inv√°lido");
            currentUser = user;
            showDashboard();
          } else {
            showLoginScreen();
          }
        } catch (err) {
          console.error("Erro ao verificar sess√£o:", err);
          showLoginScreen();
        }
      });

      // ‚úÖ Tela de login
      function showLoginScreen() {
        document.getElementById("loginScreen").style.display = "flex";
        document.getElementById("dashboard").classList.add("hidden");
      }

      // ‚úÖ Tela de dashboard
      function showDashboard() {
        document.getElementById("loginScreen").style.display = "none";
        document.getElementById("dashboard").classList.remove("hidden");
        loadUserData();
        loadLinks();
      }

      // ‚úÖ Alternar entre formul√°rios
      function showRegisterForm() {
        document.getElementById("loginForm").style.display = "none";
        document.getElementById("registerForm").style.display = "block";
        clearMessage("authMessage");
      }

      function showLoginForm() {
        document.getElementById("registerForm").style.display = "none";
        document.getElementById("loginForm").style.display = "block";
        clearMessage("authMessage");
      }

      // ‚úÖ Registro de usu√°rio
      async function register() {
        const name = document.getElementById("registerName").value;
        const email = document.getElementById("registerEmail").value;
        const password = document.getElementById("registerPassword").value;

        if (!name || !email || !password) {
          showMessage("authMessage", "Preencha todos os campos", "error");
          return;
        }

        try {
          const { data, error } = await supabase.auth.signUp({
            email,
            password,
            options: {
              data: {
                full_name: name,
              },
            },
          });

          if (error) {
            showMessage("authMessage", error.message, "error");
          } else {
            showMessage(
              "authMessage",
              "Conta criada! Verifique seu email.",
              "success"
            );
            setTimeout(() => showLoginForm(), 3000);
          }
        } catch (error) {
          showMessage(
            "authMessage",
            "Erro ao criar conta: " + error.message,
            "error"
          );
        }
      }

      // ‚úÖ Login
      async function login() {
        const email = document.getElementById("loginEmail").value;
        const password = document.getElementById("loginPassword").value;

        if (!email || !password) {
          showMessage("authMessage", "Preencha todos os campos", "error");
          return;
        }

        try {
          const { data, error } = await supabase.auth.signInWithPassword({
            email,
            password,
          });

          if (error) {
            showMessage("authMessage", error.message, "error");
            return;
          }

          const session = data.session;
          if (!session) {
            showMessage(
              "authMessage",
              "E-mail n√£o confirmado ou sess√£o inv√°lida.",
              "error"
            );
            return;
          }

          currentUser = data.user;
          showDashboard();
        } catch (error) {
          showMessage(
            "authMessage",
            "Erro ao fazer login: " + error.message,
            "error"
          );
        }
      }

      // ‚úÖ Logout
      async function logout() {
        try {
          await supabase.auth.signOut();
          currentUser = null;
          showLoginScreen();
        } catch (error) {
          console.error("Erro ao sair:", error);
        }
      }

      // ‚úÖ Ver p√°gina p√∫blica
      function viewPublicPage() {
        if (!currentUser) {
          alert("Usu√°rio n√£o encontrado");
          return;
        }

        console.log("Abrindo p√°gina p√∫blica para usu√°rio:", currentUser.id);
        const publicUrl = `./index.html?user=${currentUser.id}`;
        console.log("URL da p√°gina p√∫blica:", publicUrl);
        window.open(publicUrl, "_blank");
      }

      // ‚úÖ Carregar dados do usu√°rio
      async function loadUserData() {
        if (!currentUser) return;

        try {
          // Buscar perfil do usu√°rio
          const { data: profile, error } = await supabase
            .from("profiles")
            .select("*")
            .eq("user_id", currentUser.id)
            .single();

          if (error && error.code !== "PGRST116") {
            console.error("Erro ao carregar perfil:", error);
            return;
          }

          // Atualizar interface
          const userName =
            profile?.name || currentUser.user_metadata?.full_name || "Usu√°rio";
          const userEmail = currentUser.email;
          const userDescription = profile?.description || "";
          const userPhoto = profile?.photo_url;

          document.getElementById("userName").textContent = userName;
          document.getElementById("userEmail").textContent = userEmail;
          document.getElementById("profileName").value = userName;
          document.getElementById("profileDescription").value = userDescription;

          // Avatar
          const avatar = document.getElementById("userAvatar");
          const profilePreview = document.getElementById("profilePreview");
          const profileInitials = document.getElementById("profileInitials");

          if (userPhoto) {
            avatar.innerHTML = `<img src="${userPhoto}" alt="Avatar" class="w-full h-full object-cover rounded-full">`;
            profilePreview.innerHTML = `<img src="${userPhoto}" alt="Perfil" class="w-full h-full object-cover rounded-full">`;
          } else {
            const initials = userName
              .split(" ")
              .map((n) => n[0])
              .join("")
              .toUpperCase()
              .substring(0, 2);
            avatar.textContent = initials;
            profileInitials.textContent = initials;
          }
        } catch (error) {
          console.error("Erro ao carregar dados do usu√°rio:", error);
        }
      }

      // ‚úÖ Salvar perfil
      async function saveProfile() {
        if (!currentUser) return;

        const name = document.getElementById("profileName").value;
        const description = document.getElementById("profileDescription").value;

        if (!name) {
          showMessage("dashboardMessage", "Nome √© obrigat√≥rio", "error");
          return;
        }

        try {
          const { error } = await supabase.from("profiles").upsert({
            user_id: currentUser.id,
            name: name,
            description: description,
            updated_at: new Date().toISOString(),
          });

          if (error) throw error;

          showMessage(
            "dashboardMessage",
            "Perfil salvo com sucesso!",
            "success"
          );
          loadUserData();
          setTimeout(() => clearMessage("dashboardMessage"), 3000);
        } catch (error) {
          console.error("Erro ao salvar perfil:", error);
          showMessage("dashboardMessage", "Erro ao salvar perfil", "error");
        }
      }

      // ‚úÖ Upload de imagem do perfil
      async function uploadProfileImage() {
        if (!currentUser) return;

        const fileInput = document.getElementById("profileImage");
        const file = fileInput.files[0];

        if (!file) return;

        try {
          const fileExt = file.name.split(".").pop();
          const fileName = `${currentUser.id}.${fileExt}`;

          const { error: uploadError } = await supabase.storage
            .from("avatars")
            .upload(fileName, file, { upsert: true });

          if (uploadError) throw uploadError;

          const { data } = supabase.storage
            .from("avatars")
            .getPublicUrl(fileName);

          const { error: updateError } = await supabase
            .from("profiles")
            .upsert({
              user_id: currentUser.id,
              photo_url: data.publicUrl,
              updated_at: new Date().toISOString(),
            });

          if (updateError) throw updateError;

          showMessage(
            "dashboardMessage",
            "Foto atualizada com sucesso!",
            "success"
          );
          loadUserData();
          setTimeout(() => clearMessage("dashboardMessage"), 3000);
        } catch (error) {
          console.error("Erro ao fazer upload:", error);
          showMessage("dashboardMessage", "Erro ao atualizar foto", "error");
        }
      }

      // ‚úÖ Carregar links
      async function loadLinks() {
        if (!currentUser) return;

        try {
          const { data: links, error } = await supabase
            .from("links")
            .select("*")
            .eq("user_id", currentUser.id)
            .order("created_at", { ascending: false });

          if (error) throw error;

          const container = document.getElementById("linksList");

          if (!links || links.length === 0) {
            container.innerHTML = `
              <div class="text-center py-8">
                <div class="text-6xl mb-4">üîó</div>
                <p class="text-gray-500">Nenhum link adicionado ainda</p>
                <p class="text-sm text-gray-400">Clique em "Adicionar Link" para come√ßar</p>
              </div>
            `;
            return;
          }

          container.innerHTML = "";

          links.forEach((link) => {
            const linkElement = document.createElement("div");
            linkElement.className =
              "bg-gray-50 rounded-lg p-4 flex items-center justify-between hover:bg-gray-100 transition";
            linkElement.innerHTML = `
              <div class="flex items-center gap-3">
                <span class="text-2xl">${link.icon || "üîó"}</span>
                <div>
                  <div class="font-semibold">${link.title}</div>
                  <div class="text-sm text-gray-500">${link.url}</div>
                </div>
              </div>
              <div class="flex gap-2">
                <button onclick="editLink('${
                  link.id
                }')" class="px-3 py-1 bg-blue-500 text-white rounded text-sm hover:bg-blue-600">
                  Editar
                </button>
                <button onclick="deleteLink('${
                  link.id
                }')" class="px-3 py-1 bg-red-500 text-white rounded text-sm hover:bg-red-600">
                  Excluir
                </button>
              </div>
            `;
            container.appendChild(linkElement);
          });
        } catch (error) {
          console.error("Erro ao carregar links:", error);
          document.getElementById("linksList").innerHTML = `
            <div class="text-center py-6 text-red-500">
              Erro ao carregar links
            </div>
          `;
        }
      }

      // ‚úÖ Modal de link
      function showAddLinkModal() {
        editingLinkId = null;
        document.getElementById("modalTitle").textContent = "Adicionar Link";
        document.getElementById("linkTitle").value = "";
        document.getElementById("linkUrl").value = "";
        document.getElementById("linkIcon").value = "";
        document.getElementById("linkType").value = "product";
        document.getElementById("linkModal").classList.remove("hidden");
        document.getElementById("linkModal").classList.add("flex");
      }

      function closeLinkModal() {
        document.getElementById("linkModal").classList.add("hidden");
        document.getElementById("linkModal").classList.remove("flex");
        editingLinkId = null;
      }

      // ‚úÖ Editar link
      async function editLink(linkId) {
        try {
          const { data: link, error } = await supabase
            .from("links")
            .select("*")
            .eq("id", linkId)
            .single();

          if (error) throw error;

          editingLinkId = linkId;
          document.getElementById("modalTitle").textContent = "Editar Link";
          document.getElementById("linkTitle").value = link.title;
          document.getElementById("linkUrl").value = link.url;
          document.getElementById("linkIcon").value = link.icon || "";
          document.getElementById("linkType").value = link.type || "product";
          document.getElementById("linkModal").classList.remove("hidden");
          document.getElementById("linkModal").classList.add("flex");
        } catch (error) {
          console.error("Erro ao carregar link:", error);
          showMessage("dashboardMessage", "Erro ao carregar link", "error");
        }
      }

      // ‚úÖ Salvar link
      async function saveLink() {
        if (!currentUser) return;

        const title = document.getElementById("linkTitle").value;
        const url = document.getElementById("linkUrl").value;
        const icon = document.getElementById("linkIcon").value;
        const type = document.getElementById("linkType").value;

        if (!title || !url) {
          alert("T√≠tulo e URL s√£o obrigat√≥rios");
          return;
        }

        try {
          if (editingLinkId) {
            // Atualizar link existente
            const { error } = await supabase
              .from("links")
              .update({
                title,
                url,
                icon,
                type,
                updated_at: new Date().toISOString(),
              })
              .eq("id", editingLinkId);

            if (error) throw error;
            showMessage(
              "dashboardMessage",
              "Link atualizado com sucesso!",
              "success"
            );
          } else {
            // Criar novo link
            const { error } = await supabase.from("links").insert({
              user_id: currentUser.id,
              title,
              url,
              icon,
              type,
              created_at: new Date().toISOString(),
            });

            if (error) throw error;
            showMessage(
              "dashboardMessage",
              "Link adicionado com sucesso!",
              "success"
            );
          }

          closeLinkModal();
          loadLinks();
          setTimeout(() => clearMessage("dashboardMessage"), 3000);
        } catch (error) {
          console.error("Erro ao salvar link:", error);
          alert("Erro ao salvar link");
        }
      }

      // ‚úÖ Excluir link
      async function deleteLink(linkId) {
        if (!confirm("Tem certeza que deseja excluir este link?")) return;

        try {
          const { error } = await supabase
            .from("links")
            .delete()
            .eq("id", linkId);

          if (error) throw error;

          showMessage(
            "dashboardMessage",
            "Link exclu√≠do com sucesso!",
            "success"
          );
          loadLinks();
          setTimeout(() => clearMessage("dashboardMessage"), 3000);
        } catch (error) {
          console.error("Erro ao excluir link:", error);
          showMessage("dashboardMessage", "Erro ao excluir link", "error");
        }
      }

      // ‚úÖ Mostrar mensagens
      function showMessage(elementId, message, type) {
        const element = document.getElementById(elementId);
        const className =
          type === "error"
            ? "bg-red-100 text-red-700 border-red-300"
            : "bg-green-100 text-green-700 border-green-300";
        element.innerHTML = `<div class="p-3 rounded-lg border ${className} mb-4">${message}</div>`;
      }

      function clearMessage(elementId) {
        document.getElementById(elementId).innerHTML = "";
      }

      // ‚úÖ Event listeners para teclas Enter
      document.addEventListener("DOMContentLoaded", function () {
        document
          .getElementById("loginPassword")
          .addEventListener("keypress", function (e) {
            if (e.key === "Enter") login();
          });

        document
          .getElementById("registerPassword")
          .addEventListener("keypress", function (e) {
            if (e.key === "Enter") register();
          });
      });
    </script>
  </body>
</html>
